<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta http-equiv="Permissions-Policy" content="gamepad=(self); camera=(self); microphone=()">
    <title>Snap Station</title>
    <!-- Removed Google Fonts for Utilitarian System Look -->
    <style>
        :root {
            /* Renamed variables to match Viewer logic but styled for Printer/Utility */
            --bg: #1a264e;
            --panel: #223464;
            --text: #ffffff;
            --border: #ffcb05; /* YELLOW BORDER */
            --accent: #ffcb05;
            --btn-hover: #ffcb05;
            --btn-bg: #223464;
            --shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        /* Unified Theme Colors applied to Utility Structure */
        [data-theme="video-rental"] { 
            --bg: #1a264e; 
            --panel: #223464; 
            --text: #ffffff; 
            --border: #ffcb05; 
            --accent: #ffcb05; 
            --btn-hover: #ffcb05; 
            --btn-bg: #223464; 
        }
        
        [data-theme="dark"] { --bg: #1a1e23; --panel: #2d333b; --text: #e6e6e6; --border: #444c56; --accent: #58a6ff; --btn-hover: #1f6feb; --btn-bg: #21262d; }
        [data-theme="light"] { --bg: #f0f2f5; --panel: #ffffff; --text: #333333; --border: #d0d7de; --accent: #0969da; --btn-hover: #0969da; --btn-bg: #f6f8fa; }
        [data-theme="retro"] { --bg: #01009a; --panel: #f5b201; --text: #000000; --border: #e10916; --accent: #329900; --btn-hover: #e10916; --btn-bg: #ffffff; }
        [data-theme="hearts"] { --bg: #FFB6C1; --panel: rgba(255, 255, 255, 0.95); --text: #8b1a4a; --border: #ff69b4; --accent: #ff1493; --btn-hover: #ff69b4; --btn-bg: #ffffff; }
        [data-theme="vines"] { --bg: #C1FFB6; --panel: rgba(255, 255, 255, 0.95); --text: #1a3d18; --border: #4caf50; --accent: #388e3c; --btn-hover: #4caf50; --btn-bg: #ffffff; }
        [data-theme="1-up"] { --bg: #5c94fc; --panel: #c84c0c; --text: #ffffff; --border: #000000; --accent: #fca044; --btn-hover: #e45c10; --btn-bg: #c84c0c; }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow-x: hidden; }

        body {
            /* System Fonts for Utilitarian Look */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 20px;
            transition: background-color 0.3s ease;
            position: relative;
        }

        /* --- Global Typography --- */
        h1, h2, h3, .brand-text {
            font-family: inherit; /* Inherit system font */
            text-transform: none; /* Removed heavy uppercase */
            letter-spacing: normal;
            font-weight: 800;
            color: var(--text);
        }
        
        button, select, input, .btn {
            font-family: inherit;
        }

        /* --- Animation --- */
        .emoji-wallpaper {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 0; overflow: hidden; opacity: 0;
            transition: opacity 0.5s ease;
        }
        .emoji-wallpaper.active { opacity: 1; }
        .emoji-wallpaper span {
            position: absolute; font-size: 24px; opacity: 0.6;
            animation: float 8s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-15px) rotate(10deg); }
        }

        .container {
            position: relative; z-index: 1; width: 100%; max-width: 900px;
            display: flex; flex-direction: column; align-items: center; gap: 20px;
        }

        header { text-align: center; margin-bottom: 10px; }
        h1 {
            font-size: clamp(1.5rem, 4vw, 2.2rem);
            margin-bottom: 0.2rem;
        }

        /* --- Utilitarian UI Panels (Snap Printer Style) --- */
        .monitor-frame {
            background: var(--panel); 
            border: 2px solid var(--border); /* Thick Yellow Border */
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            width: 100%; max-width: 800px; transition: all 0.3s ease;
        }

        .siren-container {
            display: flex; justify-content: center; align-items: center; margin-bottom: 12px;
            height: 40px; cursor: pointer; user-select: none;
        }
        .siren { font-size: 1.5rem; opacity: 0.3; transition: opacity 0.1s ease; filter: grayscale(100%); }
        .siren.active { opacity: 1; filter: grayscale(0%); }
        /* Animation duration 1s */
        .siren.flashing { animation: sirenFlash 1s infinite; }
        @keyframes sirenFlash {
            0%, 49.9% { opacity: 1; filter: grayscale(0%); }
            50%, 100% { opacity: 0.3; filter: grayscale(100%); }
        }

        .video-container {
            position: relative; width: 100%; background: #000; border-radius: 8px;
            overflow: hidden; aspect-ratio: 16 / 9;
            transition: aspect-ratio 0.3s ease, border-color 0.2s ease, box-shadow 0.2s ease;
            cursor: grab; touch-action: none; border: 2px solid var(--border);
        }
        .video-container:active { cursor: grabbing; }
        .video-container.gamepad-focus-visible {
            outline: 3px solid var(--accent);
        }
        .video-container.ratio-4-3 { aspect-ratio: 4 / 3; }
        
        #webcam {
            width: 100%; height: 100%; object-fit: cover;
            object-position: center center; display: none;
            transform-origin: center center;
            will-change: transform; 
        }

        .crt-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10;
            pointer-events: none;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%),
                        linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 4px, 6px 100%; opacity: 0; transition: opacity 0.3s ease;
        }
        .crt-overlay.active { opacity: 1; }

        .flash-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 30;
            background-color: white; opacity: 0; pointer-events: none; transition: opacity 0.1s ease-out;
        }
        .flash-overlay.active { opacity: 1; transition: none; }

        .video-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; align-items: center; justify-content: center; z-index: 20;
        }

        .recording-indicator {
            position: absolute; top: 15px; right: 15px; display: flex; align-items: center; gap: 8px;
            background: rgba(220, 53, 69, 0.9); color: white; padding: 6px 12px; border-radius: 4px;
            font-size: 0.8rem; font-weight: 600; opacity: 0; transition: opacity 0.3s ease;
        }
        .recording-indicator.active { opacity: 1; }
        .recording-indicator .dot {
            width: 10px; height: 10px; background: white; border-radius: 50%; animation: blink 1s infinite;
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        .no-camera {
            position: absolute; inset: 0; display: flex; flex-direction: column;
            align-items: center; justify-content: center; color: #888; font-size: 1rem;
            text-align: center; padding: 20px; background: #000;
        }
        .no-camera-icon { font-size: 3rem; margin-bottom: 10px; opacity: 0.4; }

        /* --- Refined Buttons --- */
        .controls {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%;
            max-width: 900px; margin-top: 15px;
        }
        @media (min-width: 800px) { .controls { grid-template-columns: repeat(4, 1fr); } }

        .btn {
            font-size: 0.9rem; font-weight: 600;
            padding: 10px 16px; 
            border: 2px solid var(--border);
            border-radius: 6px; 
            background: var(--panel); color: var(--text); cursor: pointer;
            transition: all 0.1s ease; display: flex; align-items: center; justify-content: center;
            gap: 8px; width: 100%; min-height: 44px;
        }
        
        .btn:hover, .btn:active { 
            background: var(--accent); 
            color: var(--bg);
            transform: translateY(-1px); 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); 
            border-color: var(--accent); 
        }
        
        .btn:focus {
            outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(255, 203, 5, 0.3);
            z-index: 5;
        }
        .btn:active { transform: translateY(0); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; background: rgba(0,0,0,0.2); border-color: #555; color: #888; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; width: auto; min-height: 32px; }
        
        .btn-toggle.active { background: var(--accent); color: var(--bg); border-color: var(--accent); }
        .btn-primary { background: var(--panel); color: white; border-color: var(--border); }
        .btn-primary:hover { background: var(--accent); color: var(--bg); }

        .fx-controls {
            display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;
            align-items: center; margin-top: 10px; padding: 10px;
            background: rgba(0,0,0,0.2); border-radius: 8px; width: 100%; border: 2px dashed var(--border);
        }

        .tooltip-container { position: relative; display: inline-block; }
        .help-btn {
            background: var(--panel); color: var(--text); border: 2px solid var(--border);
            border-radius: 50%; width: 24px; height: 24px; font-weight: bold; cursor: help;
            display: flex; align-items: center; justify-content: center; transition: all 0.2s ease;
            font-size: 0.8rem;
        }
        .help-btn:hover, .help-btn:focus { background: var(--accent); color: var(--bg); outline: none; }

        .tooltip-content {
            visibility: hidden; width: 280px; background-color: var(--panel); color: var(--text);
            text-align: left; border-radius: 6px; padding: 12px; position: absolute; z-index: 100;
            bottom: 135%; left: 50%; transform: translateX(-50%); opacity: 0;
            transition: opacity 0.2s; border: 1px solid var(--border); font-size: 0.8rem;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }
        .tooltip-content.visible { visibility: visible; opacity: 1; }
        .tooltip-content::after {
            content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px;
            border-width: 5px; border-style: solid; border-color: var(--border) transparent transparent transparent;
        }

        .tooltip-list { list-style: none; padding: 0; margin: 0; }
        .tooltip-list li { margin-bottom: 6px; display: flex; align-items: flex-start; }
        .tooltip-icon { margin-right: 8px; min-width: 20px; text-align: center; }
        .tooltip-header {
            font-weight: bold; border-bottom: 1px solid var(--border); padding-bottom: 5px;
            margin-bottom: 8px; color: var(--accent);
        }

        .controls-label { font-weight: 600; font-size: 0.85rem; margin-right: 8px; }
        .controls-select {
            font-size: 0.9rem; padding: 6px 12px;
            border: 2px solid var(--border); border-radius: 6px; background: var(--panel);
            color: var(--text); cursor: pointer;
        }
        .controls-select:hover { border-color: #fff; }

        .ratio-toggle {
            display: flex; border: 2px solid var(--border); border-radius: 6px;
            overflow: hidden; background: var(--panel); width: 100%; min-height: 44px;
        }
        .ratio-option {
            font-size: 0.85rem; font-weight: 600;
            border: none; background: transparent; color: var(--text); cursor: pointer;
            flex: 1; display: flex; align-items: center; justify-content: center;
        }
        .ratio-option:first-child { border-right: 2px solid var(--border); }
        .ratio-option:hover { background: rgba(255,255,255,0.1); }
        .ratio-option.active { background: var(--accent); color: var(--bg); }

        .video-container:fullscreen, .video-container:-webkit-full-screen {
            background: #000; display: flex; align-items: center; justify-content: center;
        }
        .video-container:fullscreen #webcam { max-width: 100%; max-height: 100%; width: auto; height: auto; object-fit: contain; }

        .timer-display {
            font-family: monospace; font-size: 2rem; font-weight: bold;
            color: white; background: rgba(0, 0, 0, 0.7); padding: 10px 20px;
            border-radius: 8px; opacity: 0; transition: opacity 0.3s ease;
        }
        .timer-display.active { opacity: 1; }

        .status-bar { margin-top: 10px; font-size: 0.8rem; opacity: 0.7; text-align: center; min-height: 20px; }

        .gallery-container { width: 100%; margin-top: 20px; padding-top: 20px; border-top: 2px dashed var(--border); }
        .gallery-title { font-size: 1.1rem; margin-bottom: 0; color: var(--text); }
        .gallery {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px; width: 100%;
        }
        
        .snap-wrapper { position: relative; cursor: pointer; transition: transform 0.2s; }
        .snap-wrapper:hover { transform: scale(1.02); }
        .snap-preview { width: 100%; border-radius: 6px; border: 2px solid var(--border); display: block; aspect-ratio: 16/9; object-fit: cover; }
        .snap-wrapper:hover .snap-preview { border-color: #fff; }
        
        /* Selected State Styling */
        .snap-wrapper.selected .snap-preview { 
            border-color: #4ade80; /* Bright Green */
            box-shadow: 0 0 0 4px #4ade80;
        }
        .snap-wrapper.selected { transform: scale(0.95); }

        .snap-badge {
            position: absolute; top: 4px; right: 4px; background: rgba(0, 0, 0, 0.6);
            border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center;
            justify-content: center; font-size: 12px; pointer-events: none;
            color: white; z-index: 2;
        }
        
        .empty-gallery { text-align: center; opacity: 0.5; padding: 20px; font-size: 0.9rem; grid-column: 1 / -1; }

        .gamepad-indicator {
            position: fixed; bottom: 20px; right: 20px; background: rgba(0, 0, 0, 0.85);
            color: white; padding: 8px 12px; border-radius: 6px; font-size: 0.8rem;
            font-weight: 600; display: none; align-items: center; gap: 8px; z-index: 1000;
        }
        .gamepad-indicator.visible { display: flex; }

        .undo-toast {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: #333; color: white; padding: 10px 16px; border-radius: 6px;
            display: flex; align-items: center; gap: 15px; z-index: 1001;
            font-size: 0.85rem; opacity: 0; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .undo-toast.visible { transform: translateX(-50%) translateY(0); opacity: 1; }
        .undo-toast button {
            background: transparent; color: #58a6ff; border: none; padding: 4px 8px;
            border-radius: 4px; cursor: pointer; font-weight: 600; text-transform: uppercase; font-size: 0.75rem;
        }
        .undo-toast button:hover { background: rgba(255,255,255,0.1); }

        .gallery-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .gallery-counter { font-size: 0.8rem; opacity: 0.7; }
        .gallery-counter.warning { color: #ffc107; opacity: 1; }
        .gallery-counter.full { color: #dc3545; opacity: 1; }
        
        /* New Gallery Actions Toolbar */
        .gallery-actions { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; justify-content: center; }

        .snap-wrapper.gamepad-focus { outline: 2px solid var(--accent); outline-offset: 2px; transform: scale(1.02); z-index: 10; }
        .snap-wrapper.gamepad-focus .snap-preview { border-color: var(--accent); }

        #captureCanvas { display: none; }

        @media (max-width: 600px) {
            body { padding: 10px; }
            .monitor-frame { padding: 15px; border-radius: 10px; }
            .controls { gap: 8px; }
            .btn { padding: 12px 14px; font-size: 0.85rem; }
        }
    </style>
</head>
<body data-theme="video-rental">
    <div class="emoji-wallpaper" id="emojiWallpaper"></div>
    
    <!-- Main Snap Station View -->
    <div class="container" id="mainApp">
        <header>
            <h1>üì∑ Snap Station</h1>
        </header>

        <div class="monitor-frame">
            <div class="siren-container" id="sirenContainer" title="Click to toggle flashing">
                <span class="siren" id="siren">üö®</span>
            </div>
            
            <div class="video-container" id="videoContainer" title="Scroll to zoom, drag to pan, double click to reset">
                <video id="webcam" autoplay playsinline webkit-playsinline muted></video>
                <div class="crt-overlay" id="crtOverlay"></div>
                <div class="flash-overlay" id="flashOverlay"></div>
                <div class="video-overlay">
                    <div class="recording-indicator" id="recordingIndicator">
                        <span class="dot"></span> <span>REC</span>
                    </div>
                    <div class="timer-display" id="timerDisplay">5</div>
                </div>
                <div class="no-camera" id="noCamera">
                    <div class="no-camera-icon">üì∑</div>
                    <p id="noCameraMessage">Camera access required</p>
                    <p style="font-size: 0.9rem; margin-top: 10px;">Click "Start Camera" below</p>
                </div>
            </div>

            <div class="controls">
                <button class="btn" id="startCameraBtn"><span class="btn-icon">üì∑</span>Start Camera</button>
                <button class="btn" id="shareScreenBtn"><span class="btn-icon">üñ•Ô∏è</span>Share Screen</button>
                <div class="ratio-toggle" id="ratioToggle">
                    <button class="ratio-option active" data-ratio="16:9">16:9</button>
                    <button class="ratio-option" data-ratio="4:3">4:3</button>
                </div>
                <button class="btn" id="fullscreenBtn" title="Toggle fullscreen"><span class="btn-icon" id="fullscreenIcon">‚õ∂</span>Fullscreen</button>
                <button class="btn btn-primary" id="screenshotBtn" disabled><span class="btn-icon">üì∏</span>Take Picture</button>
                <button class="btn btn-primary" id="gifBtn" disabled><span class="btn-icon">üé¨</span>Record GIF</button>
                <button class="btn" id="saveProfileBtn" title="Save current settings and snaps"><span class="btn-icon">üíæ</span> Save Profile</button>
                <button class="btn" id="loadProfileBtn" title="Load a saved profile"><span class="btn-icon">üìÇ</span> Load Profile</button>
                <input type="file" id="profileInput" style="display: none;" accept=".json">
            </div>
            
            <div class="fx-controls">
                <div class="tooltip-container">
                    <div class="help-btn" id="helpBtn" tabindex="0">?</div>
                    <div class="tooltip-content" id="helpTooltip">
                        <div class="tooltip-header">STATION GUIDE</div>
                        <ul class="tooltip-list">
                            <li><span class="tooltip-icon">üñ±Ô∏è</span><span><b>Zoom/Pan:</b> Scroll to zoom, Drag to move.</span></li>
                            <li><span class="tooltip-icon">üì∏</span><span><b>Snap:</b> Click to Select. Use toolbar to act.</span></li>
                            <li><span class="tooltip-icon">üé¨</span><span><b>GIF:</b> Records 5s loop.</span></li>
                            <li><span class="tooltip-icon">üéÆ</span><span><b>Gamepad:</b> L1+L2+R1+R2 to Toggle Mode.</span></li>
                        </ul>
                    </div>
                </div>

                <button class="btn btn-sm btn-toggle" id="muteToggle">üîä Sound On</button>
                <button class="btn btn-sm btn-toggle" id="crtToggle">üì∫ CRT Mode</button>
                <button class="btn btn-sm btn-toggle" id="mirrorToggle">Mirror Video</button>
                
                <div style="display: flex; align-items: center;">
                    <label for="themeSelect" class="controls-label">üé® Theme:</label>
                    <select id="themeSelect" class="controls-select">
                        <optgroup label="Color Themes" id="colorThemesGroup">
                            <option value="video-rental" selected>Video Rental</option>
                            <option value="dark">Dark</option>
                            <option value="light">Light</option>
                            <option value="retro">Retro</option>
                        </optgroup>
                        <optgroup label="Wallpaper Themes">
                            <option value="hearts">Hearts & Bubbles üíñ</option>
                            <option value="vines">Vines & Flowers üåø</option>
                        </optgroup>
                    </select>
                </div>
            </div>

            <div class="status-bar" id="statusBar"></div>

            <div class="gallery-container">
                <div class="gallery-header">
                    <h3 class="gallery-title">Recent Snaps</h3>
                    <span class="gallery-counter" id="galleryCounter">0 / 256</span>
                </div>
                <div class="gallery-actions">
                    <button class="btn btn-sm" id="selectAllBtn">‚úÖ Select All</button>
                    <button class="btn btn-sm" id="sendToStickerBtn">üì∑ Send to Stickers</button>
                    <button class="btn btn-sm" id="downloadBtn">‚¨áÔ∏è Download</button>
                    <button class="btn btn-sm" id="deleteBtn">üóëÔ∏è Delete</button>
                </div>
                <div class="gallery" id="gallery">
                    <div class="empty-gallery" id="emptyGallery">No snaps yet! Take a picture or video.</div>
                </div>
            </div>
        </div>

        <div class="gamepad-indicator" id="gamepadIndicator">
            <span class="mode-icon" id="gamepadModeIcon">üéÆ</span>
            <span id="gamepadModeText">Menu Mode</span>
        </div>

        <div class="undo-toast" id="undoToast">
            <span id="toastMessage">Action Completed</span>
        </div>
    </div>

    <canvas id="captureCanvas"></canvas>
    <script src="lib/gif.js"></script>

    <script>
        // --- Core Utilities & Sound ---
        window.SoundFX = {
            ctx: null,
            muted: false,
            init: function() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (this.ctx.state === 'suspended') {
                    this.ctx.resume().catch(e => console.warn("AudioContext resume failed", e));
                }
            },
            playTone: function(freq, type, duration, startTime = 0) {
                if (this.muted || !this.ctx) return;
                this.init();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.value = freq;
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start(this.ctx.currentTime + startTime);
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime + startTime);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + startTime + duration);
                osc.stop(this.ctx.currentTime + startTime + duration);
            },
            playNoise: function(duration) {
                this.init();
                const bufferSize = this.ctx.sampleRate * duration;
                const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                
                const noise = this.ctx.createBufferSource();
                noise.buffer = buffer;
                const gain = this.ctx.createGain();
                gain.connect(this.ctx.destination);
                noise.connect(gain);
                noise.start();
                return { node: noise, gain: gain };
            },
            shutter: function() {
                if (this.muted) return;
                this.init();
                const { gain } = this.playNoise(0.1);
                const now = this.ctx.currentTime;
                gain.gain.setValueAtTime(0.5, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            },
            flashCharge: function() {
                if (this.muted) return;
                this.init();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                const now = this.ctx.currentTime;
                osc.frequency.setValueAtTime(200, now);
                osc.frequency.exponentialRampToValueAtTime(3000, now + 0.3);
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(0.1, now + 0.2);
                gain.gain.linearRampToValueAtTime(0.3, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            },
            beep: function() { if (!this.muted) this.playTone(880, 'square', 0.1); },
            bing: function() { if (!this.muted) this.playTone(1760, 'triangle', 0.5); },
            
            // --- NEW SOUNDS ---
            printer: function() {
                if(this.muted) return;
                this.init();
                const duration = 1.5;
                const { node, gain } = this.playNoise(duration);
                const now = this.ctx.currentTime;
                
                // Bandpass filter to create "motor" sound from noise
                const filter = this.ctx.createBiquadFilter();
                filter.type = 'bandpass';
                filter.Q.value = 5;
                
                node.disconnect();
                node.connect(filter);
                filter.connect(gain);
                
                // Rev up and down
                filter.frequency.setValueAtTime(200, now);
                filter.frequency.linearRampToValueAtTime(800, now + 0.2);
                filter.frequency.linearRampToValueAtTime(800, now + 1.2);
                filter.frequency.linearRampToValueAtTime(200, now + duration);
                
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(0.3, now + 0.1);
                gain.gain.linearRampToValueAtTime(0.3, now + 1.3);
                gain.gain.linearRampToValueAtTime(0, now + duration);
            },
            
            cartridge: function() {
                if(this.muted) return;
                this.init();
                // Short, low frequency "clunk"
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.frequency.value = 150;
                osc.type = 'square';
                
                // Filter to dull the square wave into a plastic click
                const filter = this.ctx.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.value = 500;
                
                osc.connect(filter);
                filter.connect(gain);
                gain.connect(this.ctx.destination);
                
                const now = this.ctx.currentTime;
                gain.gain.setValueAtTime(0.5, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                
                osc.frequency.exponentialRampToValueAtTime(50, now + 0.1);
                
                osc.start(now);
                osc.stop(now + 0.1);
            }
        };

        // --- DOM Elements ---
        const $ = (id) => document.getElementById(id);
        const video = $('webcam');
        const videoContainer = $('videoContainer');
        const canvas = $('captureCanvas');
        const gallery = $('gallery');
        const themeSelect = $('themeSelect');
        const emojiWallpaper = $('emojiWallpaper');
        const recordingIndicator = $('recordingIndicator');
        const timerDisplay = $('timerDisplay');
        const gamepadIndicator = $('gamepadIndicator');
        
        // --- State ---
        window.stream = null;
        window.isRecording = false;
        window.currentRatio = '16:9';
        window.cameraActive = false;
        window.activeSource = null;
        window.sirenEnabled = false;
        window.crtEnabled = false;
        window.gifWorkerBlobUrl = null;
        window.nesUnlocked = false;
        window.isMirrored = false;
        window.zoomLevel = 1;
        window.panX = 0;
        window.panY = 0;
        let recordingInterval = null, countdownInterval = null;
        let undoTimeout = null;
        let transformRAF = null;
        window.snapCount = 0;

        // --- Init ---
        async function prepareGifWorker() {
            try {
                const response = await fetch('lib/gif.worker.js');
                if (!response.ok) throw new Error('Fetch failed');
                const workerScript = await response.text();
                const blob = new Blob([workerScript], { type: 'application/javascript' });
                window.gifWorkerBlobUrl = URL.createObjectURL(blob);
            } catch (e) {
                console.warn('GIF worker load failed, using direct path', e);
                window.gifWorkerBlobUrl = 'lib/gif.worker.js';
            }
        }
        prepareGifWorker();

        // --- Theming ---
        const emojiConfigs = { hearts: ['üíñ', 'ü´ß', 'üíò', 'üßº'], vines: ['üåø', 'üå∏', 'üçÉ', 'üåª'], '1-up': ['üçÑ', '‚≠ê', 'ü™ô', 'üê¢', '‚ùì'] };
        
        function generateWallpaper(theme) {
            emojiWallpaper.innerHTML = '';
            if (!emojiConfigs[theme]) { emojiWallpaper.classList.remove('active'); return; }
            
            const fragment = document.createDocumentFragment();
            const emojis = emojiConfigs[theme];
            for (let i = 0; i < 60; i++) {
                const span = document.createElement('span');
                span.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                span.style.left = `${Math.random() * 100}%`;
                span.style.top = `${Math.random() * 100}%`;
                span.style.animationDelay = `${Math.random() * 8}s`;
                span.style.fontSize = `${Math.random() * 20 + 16}px`;
                fragment.appendChild(span);
            }
            emojiWallpaper.appendChild(fragment);
            emojiWallpaper.classList.add('active');
        }

        themeSelect.addEventListener('change', (e) => {
            document.body.setAttribute('data-theme', e.target.value);
            generateWallpaper(e.target.value);
        });

        // --- Help Button Fix ---
        $('helpBtn').onclick = () => {
            $('helpTooltip').classList.toggle('visible');
            SoundFX.beep();
        };
        // Close tooltip when clicking elsewhere
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.tooltip-container')) {
                $('helpTooltip').classList.remove('visible');
            }
        });

        // --- Siren Click ---
        $('sirenContainer').onclick = () => {
            $('siren').classList.toggle('flashing');
        };

        // --- Video Control ---
        function updateTransform() {
            if (transformRAF) return;
            transformRAF = requestAnimationFrame(() => {
                const displayPanX = window.isMirrored ? -window.panX : window.panX;
                video.style.transform = `scaleX(${window.isMirrored ? -1 : 1}) translate(${displayPanX}px, ${window.panY}px) scale(${window.zoomLevel})`;
                transformRAF = null;
            });
        }

        $('muteToggle').onclick = function() { 
            SoundFX.muted = !SoundFX.muted; 
            this.textContent = SoundFX.muted ? 'üîá Muted' : 'üîä Sound On';
            this.classList.toggle('active', SoundFX.muted);
            if(!SoundFX.muted) { SoundFX.init(); SoundFX.beep(); }
        };

        $('crtToggle').onclick = function() {
            window.crtEnabled = !window.crtEnabled;
            $('crtOverlay').classList.toggle('active', window.crtEnabled);
            this.classList.toggle('active', window.crtEnabled);
            SoundFX.init();
        };

        $('mirrorToggle').onclick = function() {
            window.isMirrored = !window.isMirrored;
            this.classList.toggle('active', window.isMirrored);
            updateTransform();
            SoundFX.init();
        };

        // --- Input Handling ---
        let isDragging = false;
        let startDragX = 0, startDragY = 0;

        videoContainer.addEventListener('wheel', (e) => {
            if (!window.activeSource) return;
            e.preventDefault();
            window.zoomLevel = Math.min(Math.max(window.zoomLevel + (e.deltaY > 0 ? -0.1 : 0.1), 1), 5);
            if (window.zoomLevel === 1) { window.panX = 0; window.panY = 0; }
            updateTransform();
        }, { passive: false });

        videoContainer.addEventListener('mousedown', (e) => {
            if (!window.activeSource || window.zoomLevel <= 1) return;
            isDragging = true;
            startDragX = e.clientX - window.panX;
            startDragY = e.clientY - window.panY;
            videoContainer.style.cursor = 'grabbing';
        });

        window.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            e.preventDefault();
            window.panX = e.clientX - startDragX;
            window.panY = e.clientY - startDragY;
            updateTransform();
        });

        window.addEventListener('mouseup', () => {
            isDragging = false;
            videoContainer.style.cursor = 'grab';
        });

        videoContainer.addEventListener('dblclick', () => {
            if (!window.activeSource) return;
            window.zoomLevel = 1; window.panX = 0; window.panY = 0; updateTransform();
        });

        // --- Camera & Stream ---
        async function startStream(type) {
            SoundFX.init();
            stopStream(false);

            try {
                if (type === 'camera') {
                    window.stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } }, 
                        audio: false 
                    });
                } else {
                    window.stream = await navigator.mediaDevices.getDisplayMedia({ video: { cursor: "always" }, audio: false });
                }

                video.srcObject = window.stream;
                video.style.display = 'block';
                $('noCamera').style.display = 'none';
                await video.play().catch(e => console.error("Play error", e));

                window.cameraActive = true;
                window.activeSource = type;
                $('screenshotBtn').disabled = false;
                $('gifBtn').disabled = false;
                // Auto-start siren
                $('siren').classList.add('flashing');
                
                updateUIForStream(true, type);

                window.stream.getVideoTracks()[0].onended = () => stopStream();
            } catch (err) {
                console.warn('Stream failed:', err);
                updateStatus('Stream failed. Check permissions.');
                stopStream();
            }
        }

        function stopStream(fullReset = true) {
            if (window.isRecording) {
                window.isRecording = false;
                clearInterval(recordingInterval);
                clearInterval(countdownInterval);
                timerDisplay.classList.remove('active');
                recordingIndicator.classList.remove('active');
            }

            if (window.stream) {
                window.stream.getTracks().forEach(track => track.stop());
                window.stream = null;
            }

            if (fullReset) {
                video.srcObject = null;
                window.cameraActive = false;
                window.activeSource = null;
                video.style.display = 'none';
                $('noCamera').style.display = 'flex';
                $('screenshotBtn').disabled = true;
                $('gifBtn').disabled = true;
                // Auto-stop siren
                $('siren').classList.remove('flashing');
                
                window.zoomLevel = 1; window.panX = 0; window.panY = 0;
                updateTransform();
                updateUIForStream(false);
            }
        }

        function updateUIForStream(active, type) {
            const camBtn = $('startCameraBtn');
            const shareBtn = $('shareScreenBtn');
            
            if (active) {
                if (type === 'camera') {
                    camBtn.innerHTML = '<span class="btn-icon">‚èπÔ∏è</span> Stop Camera';
                    camBtn.classList.add('active');
                    shareBtn.innerHTML = '<span class="btn-icon">üñ•Ô∏è</span> Share Screen';
                    shareBtn.classList.remove('active');
                } else {
                    camBtn.innerHTML = '<span class="btn-icon">üì∑</span> Start Camera';
                    camBtn.classList.remove('active');
                    shareBtn.innerHTML = '<span class="btn-icon">‚èπÔ∏è</span> Stop Sharing';
                    shareBtn.classList.add('active');
                }
            } else {
                camBtn.innerHTML = '<span class="btn-icon">üì∑</span> Start Camera';
                camBtn.classList.remove('active');
                shareBtn.innerHTML = '<span class="btn-icon">üñ•Ô∏è</span> Share Screen';
                shareBtn.classList.remove('active');
            }
        }

        $('startCameraBtn').onclick = () => window.activeSource === 'camera' ? stopStream() : startStream('camera');
        $('shareScreenBtn').onclick = () => window.activeSource === 'screen' ? stopStream() : startStream('screen');
        
        // --- Capture Logic ---
        function getCaptureParams() {
            const vidW = video.videoWidth;
            const vidH = video.videoHeight;
            const is169 = window.currentRatio === '16:9';
            const targetRatio = is169 ? 16/9 : 4/3;
            
            let baseW, baseH, baseX, baseY;
            if (vidW / vidH > targetRatio) {
                baseH = vidH; baseW = vidH * targetRatio;
                baseX = (vidW - baseW) / 2; baseY = 0;
            } else {
                baseW = vidW; baseH = vidW / targetRatio;
                baseX = 0; baseY = (vidH - baseH) / 2;
            }

            const viewW = baseW / window.zoomLevel;
            const viewH = baseH / window.zoomLevel;
            const scaleFactor = (vidW / video.offsetWidth) / window.zoomLevel;
            const panOffsetX = (window.isMirrored ? window.panX : -window.panX) * scaleFactor;
            const panOffsetY = -window.panY * scaleFactor;
            const centerX = baseX + baseW / 2 + panOffsetX;
            const centerY = baseY + baseH / 2 + panOffsetY;
            
            return {
                sx: centerX - viewW / 2,
                sy: centerY - viewH / 2,
                sw: viewW, sh: viewH,
                dw: baseW, dh: baseH
            };
        }

        $('screenshotBtn').onclick = async () => {
            if (!window.cameraActive) return;
            SoundFX.init();
            SoundFX.flashCharge();
            await new Promise(r => setTimeout(r, 300));
            
            const flash = $('flashOverlay');
            flash.classList.add('active');
            setTimeout(() => flash.classList.remove('active'), 50);
            SoundFX.shutter();

            const cp = getCaptureParams();
            canvas.width = cp.dw;
            canvas.height = cp.dh;
            const ctx = canvas.getContext('2d');
            
            if (window.isMirrored) { ctx.translate(cp.dw, 0); ctx.scale(-1, 1); }
            ctx.drawImage(video, cp.sx, cp.sy, cp.sw, cp.sh, 0, 0, cp.dw, cp.dh);
            
            const dataUrl = canvas.toDataURL('image/jpeg', 0.85);
            addToGallery(dataUrl, 'jpg');
        };

        // --- GIF Logic ---
        $('gifBtn').onclick = () => {
            if (!window.cameraActive || window.isRecording) return;
            SoundFX.init();
            window.isRecording = true;
            $('gifBtn').disabled = true;
            $('screenshotBtn').disabled = true;
            recordingIndicator.classList.add('active');
            timerDisplay.classList.add('active');
            
            let frames = [];
            let frameCount = 0;
            let timeRemaining = 5;
            timerDisplay.textContent = timeRemaining;
            SoundFX.beep();

            countdownInterval = setInterval(() => {
                timeRemaining--;
                timerDisplay.textContent = timeRemaining;
                if(timeRemaining <= 0) { clearInterval(countdownInterval); SoundFX.bing(); }
                else SoundFX.beep();
            }, 1000);

            recordingInterval = setInterval(() => {
                if (!window.cameraActive || frameCount >= 50) { 
                    clearInterval(recordingInterval);
                    finishGif(frames);
                    return;
                }
                const cp = getCaptureParams();
                const scale = 480 / cp.dw;
                const c = document.createElement('canvas');
                c.width = 480; c.height = cp.dh * scale;
                const ctx = c.getContext('2d');
                if (window.isMirrored) { ctx.translate(c.width, 0); ctx.scale(-1, 1); }
                ctx.drawImage(video, cp.sx, cp.sy, cp.sw, cp.sh, 0, 0, c.width, c.height);
                frames.push(c);
                frameCount++;
            }, 100);
        };

        function finishGif(frames) {
            timerDisplay.classList.remove('active');
            recordingIndicator.classList.remove('active');
            updateStatus('Processing GIF...');
            
            const gif = new GIF({
                workers: 2, quality: 10, width: frames[0].width, height: frames[0].height,
                workerScript: window.gifWorkerBlobUrl
            });
            frames.forEach(f => gif.addFrame(f, { delay: 100 }));
            gif.on('finished', blob => {
                updateStatus('GIF Ready!');
                setTimeout(() => updateStatus(''), 2000);
                const reader = new FileReader();
                reader.onloadend = () => addToGallery(reader.result, 'gif');
                reader.readAsDataURL(blob);
                window.isRecording = false;
                $('gifBtn').disabled = false;
                $('screenshotBtn').disabled = false;
                
                // Cleanup frames
                frames.length = 0; 
                frames = null; 
            });
            
            try {
                gif.render();
            } catch(e) {
                console.error(e);
                window.isRecording = false;
                $('gifBtn').disabled = false;
                $('screenshotBtn').disabled = false;
            }
        }

        // --- Gallery Management ---
        function updateGalleryCounter() {
            window.snapCount = document.querySelectorAll('.snap-wrapper').length;
            $('galleryCounter').textContent = `${window.snapCount} / 256`;
            $('emptyGallery').style.display = window.snapCount === 0 ? 'block' : 'none';
        }

        window.addToGallery = function(dataUrl, type, index = 0) {
            if (window.snapCount >= 256) { updateStatus('Gallery full!'); return; }

            const wrapper = document.createElement('div');
            wrapper.className = 'snap-wrapper';
            wrapper.tabIndex = 0; 
            wrapper.dataset.type = type; // Store type
            
            const img = document.createElement('img');
            img.src = dataUrl;
            img.className = 'snap-preview';
            
            const badge = document.createElement('div');
            badge.className = 'snap-badge';
            badge.textContent = type === 'gif' ? 'üé¨' : 'üì∑';
            
            // Toggle selection logic
            wrapper.onclick = () => {
                wrapper.classList.toggle('selected');
                SoundFX.beep();
            };

            wrapper.append(img, badge);
            
            if (index === 0 && gallery.firstChild) gallery.insertBefore(wrapper, gallery.firstChild);
            else gallery.appendChild(wrapper);
            
            updateGalleryCounter();
        }
        
        // --- Bulk Actions ---
        function showToast(msg) {
            const toast = $('undoToast');
            $('toastMessage').textContent = msg;
            toast.classList.add('visible');
            if (undoTimeout) clearTimeout(undoTimeout);
            undoTimeout = setTimeout(() => {
                toast.classList.remove('visible');
            }, 3000);
        }

        $('selectAllBtn').onclick = () => {
            const all = document.querySelectorAll('.snap-wrapper');
            const allSelected = Array.from(all).every(el => el.classList.contains('selected'));
            all.forEach(el => {
                if (allSelected) el.classList.remove('selected');
                else el.classList.add('selected');
            });
            SoundFX.beep();
        };

        $('deleteBtn').onclick = () => {
            const selected = document.querySelectorAll('.snap-wrapper.selected');
            if(selected.length === 0) return showToast('No snaps selected');
            
            if(confirm(`Delete ${selected.length} selected snaps?`)) {
                selected.forEach(el => el.remove());
                SoundFX.cartridge();
                
                updateGalleryCounter();
                showToast('Deleted selected snaps');
            }
        };

        const delay = ms => new Promise(res => setTimeout(res, ms));

        $('downloadBtn').onclick = async () => {
            const selected = document.querySelectorAll('.snap-wrapper.selected');
            if(selected.length === 0) return showToast('No snaps selected');
            
            SoundFX.beep();
            showToast(`Downloading ${selected.length} snaps...`);

            for (let i = 0; i < selected.length; i++) {
                const el = selected[i];
                const img = el.querySelector('img');
                const link = document.createElement('a');
                const type = el.dataset.type || 'jpg';
                link.download = `snap-${Date.now()}-${i}.${type}`;
                link.href = img.src;
                link.click();
                await delay(200);
            }
        };

        // --- Send to Sticker Sheet ---
        $('sendToStickerBtn').onclick = () => {
            const selected = document.querySelectorAll('.snap-wrapper.selected');
            if(selected.length === 0) return showToast('Select snaps to send');
            
            const images = [];
            selected.forEach(wrapper => {
                images.push(wrapper.querySelector('img').src);
            });
            
            // Store in localStorage for the wrapper/sticker sheet to access
            localStorage.setItem('snapstation-export', JSON.stringify({
                timestamp: Date.now(),
                images: images
            }));
            
            SoundFX.printer();
            showToast(`${images.length} snap${images.length !== 1 ? 's' : ''} queued. Switch to Sticker Sheet tab.`);
            
            // Deselect after sending
            selected.forEach(el => el.classList.remove('selected'));
        };

        // Removed Clear All JS as per user request

        // --- Profile Save/Load ---
        $('saveProfileBtn').onclick = () => {
            try {
                SoundFX.printer(); // New Motor Sound
                const snaps = [];
                gallery.querySelectorAll('.snap-wrapper').forEach(w => {
                    const img = w.querySelector('img');
                    const badge = w.querySelector('.snap-badge');
                    if(img && badge) snaps.push({ type: badge.textContent === 'üé¨'?'gif':'jpg', data: img.src });
                });
                const blob = new Blob([JSON.stringify({
                    settings: { theme: themeSelect.value, crt: window.crtEnabled },
                    gallery: snaps
                })], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.download = `profile-${Date.now()}.json`;
                link.href = url;
                link.click();
                URL.revokeObjectURL(url);
                showToast('Profile saved successfully!');
            } catch(err) {
                console.error('Profile save error:', err);
                showToast('Profile save failed - file may be too large');
            }
        };

        $('loadProfileBtn').onclick = () => $('profileInput').click();
        $('profileInput').onchange = (e) => {
            const f = e.target.files[0];
            if(!f) return;
            SoundFX.cartridge(); // New Click Sound
            const r = new FileReader();
            r.onload = (ev) => {
                try {
                    const d = JSON.parse(ev.target.result);
                    // Validate profile structure
                    if (!d || typeof d !== 'object') {
                        throw new Error('Invalid profile format');
                    }
                    if(d.settings?.theme) {
                        themeSelect.value = d.settings.theme;
                        themeSelect.dispatchEvent(new Event('change'));
                    }
                    if(Array.isArray(d.gallery)) {
                        d.gallery.reverse().forEach(i => {
                            // Validate each gallery item
                            if(i.data && typeof i.data === 'string' && i.data.startsWith('data:')) {
                                addToGallery(i.data, i.type || 'jpg');
                            }
                        });
                    }
                    showToast('Profile loaded successfully!');
                } catch(err) {
                    console.error('Profile load error:', err);
                    showToast('Failed to load profile - invalid file');
                }
            };
            r.readAsText(f);
            e.target.value = '';
        };

        // --- Optimized Gamepad Manager ---
        const Gamepad = {
            index: null,
            videoMode: false,
            lastBtns: {},
            lastAxes: {x:0, y:0},
            navThrottle: false,
            
            init() {
                window.addEventListener("gamepadconnected", e => {
                    this.index = e.gamepad.index;
                    this.loop();
                    updateStatus("Gamepad Ready! L1+L2+R1+R2 to Toggle Mode");
                    gamepadIndicator.classList.add('visible');
                });
                window.addEventListener("gamepaddisconnected", () => {
                    this.index = null;
                    gamepadIndicator.classList.remove('visible');
                });
            },

            loop() {
                if(this.index === null) return;
                const gp = navigator.getGamepads ? navigator.getGamepads()[this.index] : null;
                if(gp) this.check(gp);
                requestAnimationFrame(() => this.loop());
            },

            check(gp) {
                const press = (i) => gp.buttons[i]?.pressed;
                const click = (i) => press(i) && !this.lastBtns[i];
                
                // Mode Toggle (L1+R1+L2+R2)
                const L1=press(4), R1=press(5), L2=press(6), R2=press(7);
                if(L1 && R1 && L2 && R2) {
                    if(!this.toggleLock) {
                        this.videoMode = !this.videoMode;
                        this.toggleLock = true;
                        $('gamepadModeIcon').textContent = this.videoMode ? 'üìπ' : 'üéÆ';
                        $('gamepadModeText').textContent = this.videoMode ? 'Video Mode' : 'Menu Mode';
                        videoContainer.classList.toggle('gamepad-focus-visible', this.videoMode);
                        SoundFX.beep();
                    }
                } else this.toggleLock = false;

                if(this.videoMode) {
                    // Video Controls
                    if(click(0)) { window.zoomLevel = Math.min(window.zoomLevel+0.2, 5); updateTransform(); } // A
                    if(click(1)) { window.zoomLevel = Math.max(window.zoomLevel-0.2, 1); updateTransform(); } // B
                    if(click(2)) { window.zoomLevel = 1; window.panX=0; window.panY=0; updateTransform(); } // X
                    
                    // Pan (Axis/Dpad)
                    const dx = gp.axes[0], dy = gp.axes[1];
                    if(Math.abs(dx)>0.2) { window.panX -= dx * 10; updateTransform(); }
                    if(Math.abs(dy)>0.2) { window.panY -= dy * 10; updateTransform(); }
                } else {
                    // Menu Navigation - Throttled
                    const dx = Math.abs(gp.axes[0]) > 0.5 ? Math.sign(gp.axes[0]) : (press(15)?1:(press(14)?-1:0));
                    const dy = Math.abs(gp.axes[1]) > 0.5 ? Math.sign(gp.axes[1]) : (press(13)?1:(press(12)?-1:0));
                    
                    if(dx || dy) {
                        if(!this.navThrottle) {
                            this.moveFocus(dx, dy);
                            this.navThrottle = true;
                            setTimeout(() => this.navThrottle = false, 200);
                        }
                    } else this.navThrottle = false;

                    // Actions
                    if(click(0)) document.activeElement?.click(); // A
                    if(click(2)) $('screenshotBtn').click(); // X
                    if(click(9)) $('startCameraBtn').click(); // Start
                }

                // Store State
                gp.buttons.forEach((b, i) => this.lastBtns[i] = b.pressed);
            },

            moveFocus(dx, dy) {
                const el = document.activeElement;
                if(!el || el === document.body) {
                     $('startCameraBtn').focus(); return; 
                }
                const all = Array.from(document.querySelectorAll('button:not(:disabled), select, .snap-wrapper, .help-btn'));
                const r1 = el.getBoundingClientRect();
                const x1 = r1.x + r1.width/2, y1 = r1.y + r1.height/2;

                let next = null, minDist = Infinity;
                
                all.forEach(cand => {
                    if(cand === el) return;
                    const r2 = cand.getBoundingClientRect();
                    const x2 = r2.x + r2.width/2, y2 = r2.y + r2.height/2;
                    
                    // Direction Check
                    const valid = (dx===1 && x2>x1) || (dx===-1 && x2<x1) || (dy===1 && y2>y1) || (dy===-1 && y2<y1);
                    if(valid) {
                        const dist = Math.hypot(x2-x1, y2-y1);
                        if(dist < minDist) { minDist = dist; next = cand; }
                    }
                });
                if(next) { next.focus(); SoundFX.beep(); }
            }
        };
        Gamepad.init();

        // --- UI Utils ---
        function updateStatus(msg) { $('statusBar').textContent = msg; }
        document.querySelectorAll('.ratio-option').forEach(b => b.onclick = function() {
            document.querySelectorAll('.ratio-option').forEach(o => o.classList.remove('active'));
            this.classList.add('active');
            window.currentRatio = this.dataset.ratio;
            videoContainer.classList.toggle('ratio-4-3', window.currentRatio === '4:3');
            SoundFX.init();
        });
        
        $('fullscreenBtn').onclick = () => {
            if(!document.fullscreenElement) {
                videoContainer.requestFullscreen().catch(e => {
                    console.log('Fullscreen error:', e);
                    updateStatus('Fullscreen not supported');
                    setTimeout(() => updateStatus(''), 3000);
                });
            } else {
                document.exitFullscreen();
            }
        };

        // Konami
        let kCode = ['ArrowUp','ArrowUp','ArrowDown','ArrowDown','ArrowLeft','ArrowRight','ArrowLeft','ArrowRight','b','a'];
        let kIdx = 0;
        window.addEventListener('keydown', e => {
            if(e.key === kCode[kIdx] || e.key.toLowerCase() === kCode[kIdx]) {
                kIdx++;
                if(kIdx === kCode.length) {
                    if(!window.nesUnlocked) {
                        const opt = document.createElement('option');
                        opt.value = '1-up'; opt.textContent = 'üçÑ 1-UP';
                        $('colorThemesGroup').appendChild(opt);
                        window.nesUnlocked = true;
                    }
                    themeSelect.value = '1-up';
                    themeSelect.dispatchEvent(new Event('change'));
                    kIdx = 0;
                }
            } else kIdx = 0;
        });

        generateWallpaper('video-rental');
    </script>
</body>
</html>